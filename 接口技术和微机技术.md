# 接口技术和微机技术
## 接口

微机接口就是微处理器 CPU 与外部世界的连接电路，是 CPU 与外界进行信息交换的中转站。
### 接口的功能
1. 对外部设备进行寻址的功能
2. 信号转换功能
3. 数据缓冲功能
4. 联络功能
5. 中断管理功能
6. 可编程功能
### 接口的组成
硬件电路
软件编程

### 接口的 I/O 端口
1. 状态端口
2. 数据端口
3. 命令端口
### I/O 端口的编址方式
1. 统一编址
2. 独立编址
	采用专门的 I/O 指令来访问具有独立空间的 I/O 端口
### CPU 与接口数据的交换
1. 无条件方式
2. 查询方式
3. 中断方式
4. 直接存储器存取方式——DMA 方式


## 可编程并行接口 8255 A

### 概述

概述 8255 A 是一款广泛用于微处理器系统中的**并行 I/O（输入/输出）接口芯片**，(就是指 8 位、16 位或者 32 为传输单位) 由 Intel（现在的英特尔）公司设计和制造。该芯片有多个操作模式，可用于控制数字输入和输出，因此在嵌入式系统、计算机外设和工业控制等领域得到了广泛应用。

三个输入输出端口：端口 A、端口 B、端口 C。每个端口都可通过编程设定为**输出端口**或者为**输出端口**，但是各自又不同的方式和特点。

端口 C 可作为一个独立的端口使用，但是通常配合端口 A 和端口 B 工作，为这两个端口的输入和输出提供**控制联络信号**
·


### 内部结构

接口图

![image-20230920151456709](./接口技术和微机技术.assets/image-20230920151456709.png)

内部结构图：

![image-20230925200232132](./%E6%8E%A5%E5%8F%A3%E6%8A%80%E6%9C%AF%E5%92%8C%E5%BE%AE%E6%9C%BA%E6%8A%80%E6%9C%AF.assets/image-20230925200232132.png)

(1)三个 8 位端口 A、B、C
**与外设相连，与外设交换数据、控制和状态信息.**
1)端口 A 和端口 B：含一个 8 位输出锁存器和一个 8 位输入锁存器。作为输入或输出端口时，数据均被锁存.
2)端口 C：含一个 8 位数据输出锁存器和一个 8 位的数据输入缓冲器. 作为**输出时能对数据进行锁存**，**输入时不能锁存.**端口 C 可以分成两个 4 位端口，分别可以定义为输入端口或输出端口，还可定义为控制、状态端口，以配合端口 A 和端口 B 工作.
(2) A 组和 B 组
1)**端口 A 和端口 C 的高 4 位 (PC 7~PC 4)构成 A 组**，由 A 组控制部件来对它进行控制。
2)**端口 B 和端口 C 的低 4 位 (PC 3~PC 0)构成 B 组**，由 B 组控制部件对它进行控制.
**A 组和 B 组各有一个控制单元，接收来自数据总线送来的控制字，并根据控制字确定各端口的工作状态和工作方式**

(3)数据缓冲器

数据缓冲器是一个双向的三态 8 位缓冲器，它与 cpu 系统数据总线相连。

**输入数据，输出数据，控制命令字**都是通过数据总线缓冲器进行传送的。

(4)读/写控制逻辑

读写控制逻辑接收来自 CPU 地址总线（$A_0 A_1$ 就是地址总线）的信号和控制信号，并发出命令到 A 组和 B 组，

1. 把 CPU 发出的控制命令字或输出的数据通过数据总线缓冲器送到相应的端口，
2. 把外设的状态或输入的数据从相应的端口通过数据总线缓冲器送到 CPU。

### 控制字

可编程并行接口芯片，**可编程就是用指令的形式先对芯片进行初始化，**设置芯片的端口是处于输入状态还是输出状态以及每个端口的工作方式。

1. 8255 A 通过设置控制字来决定他的工作方式
2. 控制字分为两类：
   1. 工作方式控制字，可使 8255 A 的三个数据端口工作在不同的方式
   2. C 端口按位置位/复位控制字，它可使 c 端口中任何一位进行置位或复位


### 工作方式选择控制字



![image-20230920154306127](./接口技术和微机技术.assets/image-20230920154306127.png)

### 工作方式

1. 方式 0 基本输入输出方式

   **功能：**方式 0 是 8255 A 的最简单工作模式之一，它将 8255 A 的三个 8 位 I/O 端口（Port A、Port B 和 Port C）配置为一个单独的 8 位输出端口。这意味着三个端口同时用于输出，并且可以通过控制字配置输出的数据。

   基本输入输出方式适用于无条件传送和查询方式的接口电路;
   不需要应答联络信号;
   端口 A、B 和 C 的高 4 位及低 4 位都可以作为输入、输出端口;

2. 方式 1 选通输入输出方式
   适用于查询和中断方式的接口电路;
   A 和 B 口可用方式 1，但要利用 C 口提供 3 个固定的信号，联络外设和 CPU。

   **功能：**Mode 1 将 8255 A 的三个 8 位 I/O 端口分成两个组，Port A 和 Port B 组成一个双向数据总线，而 Port C 独立作为一个输入端口。这允许数据在 Port A 和 Port B 之间双向传输，而 Port C 用于输入

   当 A 口和 B 口都为方式 1，则 C 口的 6 位被占用; C 口的其他 2 位可作为方式0使用。
   A 口或 B 口中，一个为方式 1，另一个为方式 0，则 C 口中有3位被占
   用; 而其它 5 位可工作于方式 0，设为输入或输出。

3. 方式 2 双向选通输入输出方式

   方式 2: 双向选通传送方式
   适用于双向传送数据的外设
   适用于查询和中断方式的接口电路

## 中断系统和中断控制器 8259 A

### 8086 CPU 的中断系统
#### 中断系统的作用
- 多外设
- 实时处理
- 故障处理
#### 中断源
- 外部设备
- 定时中断
- 故障请求中断
- 程序性中断
外部中断：由连至 CPU 引脚上的信号引发
内部中断：由程序中断源引发
#### 中断屏蔽
为了增加中断控制的灵活性，CPU 和 I/O 接口中分别设置触发器。
- CPU 内部中断允许触发器（PSW. IF，控制可屏蔽中断）
	- 为 0：关中断，指令 CLI
	   为“1：开中断，指令 STI
	- 可屏蔽中断（INT）受中断允许触发器控制：
	- 非屏蔽中断（NMI）**不受中断允许触发器控制**：
- 在接口电路中，设置中断请求触发器和中断屏蔽触发器
	- 有中断请求时中断请求触发器置 1；
	- 若中断屏蔽触发器为“0，该请求送往 CPU，CPU 响应后触发器清“0
	- 若中断屏蔽触发器为“1，该请求不送往 CPU，称该中断请求被屏蔽
#### 终端优先级
几个中断源同时请求中断，而 CPU 一次只能为一个中断服务；
  事先为每个中断源确定一个中断优先级
  CPU 一般首先响应优先权高的中断请求
#### 中断嵌套
  允许高优先权中断源打断优先权低的中断服务，称为中断嵌套
 若新的中断源为同级或低级，（一般）不能打断正在处理的中断服务。
#### 中断优先级和中断嵌套的实现
   先**判别**优先级，进而解决多个中断**排队**和实现中断**嵌套**
   **CPU 内部中断逻辑**可以确定**内部中断**、**外部非屏蔽中断（NMI）** 和**可屏蔽中断（INTR）**  间的等级关系；
  **外部可屏蔽中断源的优先级需要通过软件（CPU）或*硬件（接口）* 方案解决**
##### 软件确定中断优先权
  - CPU 在中断服务程序中查询确定是哪个中断源提出中断请求查询的次序决定了中断优先次序，最先被查询的优先级最高
  - **优点**：不需要复杂的硬件电路，简单易实现；
  - **缺点**：中断源较多时查询时间长，中断响应速度慢。
![](attachements/Pasted%20image%2020230927195109.png)
##### 硬件确定中断优先权
**链式优先权排队电路**：中断源串行连接形成链，用逻辑电路代替查询程序。某中断源得到 CPU 中断服务后，封锁后面中断源的中断请求，前面的中断源可以提出申请。
**专用硬件一中断控制器**
如 Intel 8259 A，具有 8 个优先权控制，经级联可扩展至 64 级。编程设置工作方式，方便灵活
### 8259 A 中断工作方式
#### 中断控制器 8259 A 功能
现代计算机采用功能很强的中断系统，可同时处理多个中断源，配置中断控制器管理外部中断，功能如下：
1. 接收外部的**中断请求**；
2. 确认当前**优先级**最高的请求，并送至 CPU 的 INTR 引脚
3. 当 CPU 响应中断时，提供**中断类型码**：
4. 中断处理过程中**屏蔽**低优先权的中断请求，而允许高优先权的中断请求送出，实现中断嵌套；
5. Intel 8259 A 是典型的中断控制器芯片，广泛应用于微机系统中。
#### 8259 A 的性能概述
- 每片 8259 A 能管理 8 级中断，可采用 9 片级联构成主从式 64 级中断管理系统；
- 每级中断都可以被**屏蔽或允许**；
- 中断响应期间提供**中断类型码：**
- 允许多级中断**嵌套；**
- 可设置**多种**优先权管理方式及屏蔽功能；
- 可编程选择不同的**工作方式**
- 提供**中断查询**（中断查询（Interrupt Polling）是一种中断处理方法，用于检查外部设备是否发生了中断请求，而不是依赖硬件中断信号来通知计算机系统。），使得 CPU 在关中断的情况下仍可通过查询为特定中断服务。
#### 8259 A 的结构和引脚
示意图：
![](attachements/Pasted%20image%2020230927204515.png)
##### 8259 A 的引脚功能
- 电源 VCC 和接地 GND
- **中断请求输入线**IR 7~IRO：接受来自外设或 8259 A 从片的中断请求信号，可设置为上升沿或高电平触发；
- 双向三态数据线 D 7~DO 与系统数据总线相连；
- 中断请求线 INT：输出信号，与 CPU 的 INTR 相连，向 CPU 送中断请求信号；
- 中断响应线 INTA：接收 CPU 发来的中断响应信号，8259 A 接到此信号后，送中断类型码：
- 片选信号 CS： 高位地址译码产生；
- 地址线 AO： 选择 8259 A 内部不同寄存器；
- 读信号 RD：读取 IRR、ISR 和 IMR
- 写信号 WR：写入控制字；
- 级联线 CAS 2~CASO：主从系统中所有 CAS 2~CAS 0 引脚对应连接在一起，与 SP/EN 信号配合级联。8259 A 主片**用于输出**，**从片用于输入**。**在 CPU 响应中断时，主片用 CAS 2~CAS 0 选中对应的从片，三个引脚信号的不同组合 000~111，对应于8个从片**
- 从片编程/缓冲使能 SP/EN：双向。在**非缓冲**方式下，用作输入线 SP，SP=1 表示该 8259 A 为主片，否则为从片；缓冲方式下用作输出线 EN，控制外接数据缓冲器的接收和发送。
	-  在非缓冲方式下，"SP/EN" 用作输入线 SP（Slave Present），表示该 8259 A 控制器是主片还是从片。
		- 当 SP=1 时，表示该 8259 A 控制器是主片（Master），用于处理中断请求。
		- 当 SP=0 时，表示该 8259 A 控制器是从片（Slave），通常用于级联连接多个 8259 A 控制器以处理更多的中断请求。
	- 在非缓冲方式下，"SP/EN" 不用作输出线。
		- 在缓冲方式下，"SP/EN" 用作输出线 EN（Enable），用于控制外接数据缓冲器的接收和发送。
		- 当 "SP/EN" 为高电平时（EN=1），外接数据缓冲器被启用，允许 8259 A 控制器发送中断请求和接收中断控制命令。
		- 当 "SP/EN" 为低电平时（EN=0），外接数据缓冲器被禁用，停止发送和接收操作。
##### 内部结构
 **中断请求寄存器 IRR**：8 位，用于锁存中断请求信号。当相应的引脚有中断请求时，寄存器的相应位置 1；
**优先权判别电路 PR**：识别同时申请的中断的优先级，允许嵌套时须考虑正在服务中断的优先级别，然后送出最高优先级中断源，并在 CPU 响应周期中将中断服务寄存器 ISR 的相应位置位。
**中断服务寄存器 ISR**：8 位，记录已响应的中断。该位由普通或特殊 EOI 命令复位。中断嵌套时，会有多个位同时被置位，对应已响应而又未处理完毕的多个中断
**中断屏蔽寄存器 IMR**: 8 位，存放被屏的中断，由编程设定。当 IMR 中某位被屏蔽即使 IRR 对应位被置位，其中断申请也不能送往 CPU；
**数据总线缓冲器**：8 位双向三态缓冲器，是 8259 A 与 CPU 间的数据传输通道。写入控制字，读出状态信息。中断响应周期内，向 CPU 送中断类型码
**级联缓冲比较器**：实现 8259 A 的级联，构成主从式扩展中断管理系统；
**读写控制逻辑**：根据编程设定工作方式产生片内控制信号：据 IRR、IMR 的内容和 PR 的判断结果向 CPU 发出中断请求；并接受来自 CPU 的中断响应信号。
#### 8259 A 工作过程
1. 1 个或同时多个外部中断请求送至 8259 A 引脚
2. IRR 接收中断请求并锁存，相应位置置位 1；
3. 根据 IMR 的屏蔽情况决定是否允许中断请求进入 PR；
4. PR 判别当前优先级最高的中断请求（允许嵌套时还要参考 ISR 的状态），根据判优结果决定发送 INTR 信号或等待
5. 若 IF=1（8086 CPU 标志寄存器 FR 中的一位，IF=1 表明允许中断）, 发送 INT 信号，8259 A 使 ISR 相应位置位，同时将 IRR 相应位清零避免重发请求
6. 然后 CPU 发送第二个 INT 后 8259 A 送出类型码
7. 若为 AEOI 方式（自动结束），直接清除 ISR 相应位置，否则需要在中断服务结束时，由 CPU 送出普通或特殊中断结束命令 EOI，清除 ISR 响应的位，标志一个中断结束
#### 中断触发方式
1. ***电平触发***
	中断请求线上出现**高电平**为有效请求信号。
	对其时间有限制：过短，不能触发；过长，重复触发
	要求触发高电平持续至 cpu 响应总线周期中第一个 INTA 脉冲
2. ***边缘触发***
	中断请求线上出现**上升沿**为中断请求信号，触发后一直保持高电平也不会重复触发。常用负脉冲的后沿实现，**同时要防止第 1 个 INTA 信号有效前出现新的中断请求脉冲。**
#### 屏蔽中断源的方式
清除 IF 指令（CLI）可使 CPU 屏蔽所以可屏蔽中断，但无法屏蔽**选择性屏蔽**。
8259 A 可选择性屏蔽。
1. 普通屏蔽方式
	将中断屏蔽寄存器 IMR 的某些位置 1，选择性屏蔽对应编程
1. 特殊屏蔽方式
#### 中断优先权的四种方式
#### 中断结束的四种方式
1. 自动结束方式（有风险但是简单）：
	Cpu 一旦中断响应 8259 A 将自动 ISR 相应位置清零。由于不能再为 PR 提供判优依据，会造成重复嵌套。
	常用在不允许中断嵌套或保证不出现中断嵌套的情况下
#### 8259 A 的编程
8259 A 工作方式可以编程设定
#####  8259 A 的端口
- 8259 A 占用**两个 I/O 端口地址**，通过 A 0 引脚区分:
- 通常称低的地址为**偶地址**，而高的地址为**奇地址;**
- 8259 A 内部并不是只有两个寄存器，为**区分对不同寄存器 (命令)的输入/输出操作**，需要采用在控制信息中加**特征位**或者规定有关**操作顺序**等方法。
##### 初始化命令字
8259 A 开始工作时，必须首先写入 ICW，使其处于预定的初始状态，并明确其所处的硬件环境；
ICW 设定后整个工作过程中**保持不变**（除非断电重启）

***ICW 1:***
![](Pasted%20image%2020230927150344.png)

***ICW 2***:
![](Pasted%20image%2020230927150713.png)

高 5 位自己设置，随便设置，不要和系统的中断类型冲突
后三位是 8 级中断类型码，对应 8 个中断请求线

***ICW 3***：
![](Pasted%20image%2020230927150953.png)

***ICW 4***：
![](Pasted%20image%2020230927151054.png)

######  初始化规则
- 开始工作前，**每一片**8259 A 都要通过写入 ICW**初始化;**
- ICW 1~4 的写入顺序固定，其中 ICW 1, 和 ICW 2 必须设置，而 ICW 3 和 ICW4可选;
- **ICW 1**写入偶地址，并指明是否要**ICW 3 和 ICW 4;**
	- 写入 ICW 1 启动 8259 A 的初始化，内部电路自动完成: 边沿触发、电路复位、**IMR（Interrupt Mask Register 用于屏蔽或允许特定中断请求线）清 0**、**IR 7（Interrupt Request 7 是指 8259 A 芯片中的 IRQ 7，对应着第 7 个中断请求线）被置为最低优先级**、普通全嵌套方式、固定优先权排序、清除特殊屏蔽方式、读 IRR 状态;
- ICW 2~4 写入奇地址，按写入顺序加以区分;
- 级联方式下，主、从片都需设置 ICW 3。
***示意图：***
![](Pasted%20image%2020230927151414.png)
##### 操作命令字

***OCW 1（写中断屏蔽 IMR）***
![](Pasted%20image%2020230927152831.png)

***OCW 2***
![](Pasted%20image%2020230927153046.png)
- 控制**优先权方式**和**中断结束方式**，写入偶地址;
- D 4 D 3 是特征位;
- R: 优先权控制位，若 R=1 循环优先级，R=0 固定优先级;
- SL: 指定 L₂~L。位是否有效，SL=1，L 位有效; SL=0, L 无效;
- EOI: 中断结束命令位。当 ICW 4 中 AEOI=0，则中断服务程序最后不会发中断结束 (EOI)，则需要将 OCW 2 作为 EOI 命令，用以清除 ISR 的对应位;
- L₂~L。：（就是类似一种参数）位: 在 SL=1 时有效，编码指示对应要操作的中断级别。

### 8253 可编程定时/计数器
#### 用处
- 分时操作系统，以便切换线程。
- 统计外部事件发生的次数。
- 检测外部事件发生的频率或周期。
- 在定时或计数达到预定值后，向 CPU 申请中断。
- 向 I/O 设备周期性输出精确的定时信号。
- 用作可编程波特率或速率发生器。 
#### 定时的实现
1. 软件定时（因为每条指令的运行时间一定，所以可以定时），缺点是降低了 cpu 的利用率
2. 硬件定时： 555 电路，由阻容控制不受软件控制，无法修改，精度欠佳
3. 可编程接口芯片定时 Intel 8253
#### 外部引脚
![](attachements/Pasted%20image%2020231009144738.png)
输入引脚：
	CS: 片选信号
	RD: 读运行信号
	WR：写芯片
	A 0/A 1 地址线
连接外部设备：
	CLK：要计的时钟，是输入
	GATE：控制信号，门控信号，门控信号，用于启动/停止定时或计数工作的控制. 该信号有效时定时/计数器才开始工作
	OUT：输出，当计数完成的时候就输出

#### 内部结构
![](attachements/Pasted%20image%2020231009145434.png)
每个计数器：

![](attachements/Pasted%20image%2020231009145825.png)
减一计数器：一个<mark style="background: #FF5582A6;"><mark style="background: #FF5582A6;"> 16 位减 1 计数寄存器<mark style="background: #FF5582A6;"></mark></mark></mark>，初值为初值寄存器的值. CLK 输入一个脉冲，减1 计数寄存器的内容减 1，减到 0 时，Out 输出，只要由脉冲就计数，<mark style="background: #FF5582A6;">gate 不能控制他，gate 控制的是锁存器</mark>


### 编程
 寻址方式：
![](attachements/Pasted%20image%2020231009150300.png)
控制字
![](attachements/Pasted%20image%2020231009150347.png)
因为数据线是 8 位的所以写 16 位要分两次写
### 工作方式
#### 方式 0——计数结束后输出由低变高
