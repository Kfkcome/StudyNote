# 接口技术和微机技术

## 可编程并行接口8255A

### 概述

概述8255A是一款广泛用于微处理器系统中的**并行I/O（输入/输出）接口芯片**，(就是指8位、16位或者32为传输单位) 由Intel（现在的英特尔）公司设计和制造。该芯片有多个操作模式，可用于控制数字输入和输出，因此在嵌入式系统、计算机外设和工业控制等领域得到了广泛应用。

三个输入输出端口：端口A、端口B、端口C。每个端口都可通过编程设定为**输出端口**或者为**输出端口**，但是各自又不同的方式和特点。

端口C可作为一个独立的端口使用，但是通常配合端口A和端口B工作，为这两个端口的输入和输出提供**控制联络信号**



### 内部结构

接口图

![image-20230920151456709](./接口技术和微机技术.assets/image-20230920151456709.png)

内部结构图：

![image-20230925200232132](./%E6%8E%A5%E5%8F%A3%E6%8A%80%E6%9C%AF%E5%92%8C%E5%BE%AE%E6%9C%BA%E6%8A%80%E6%9C%AF.assets/image-20230925200232132.png)

(1)三个8位端口A、B、C
**与外设相连，与外设交换数据、控制和状态信息.**
1)端口A和端口B：含一个8位输出锁存器和一个8位输入锁存器。作为输入或输出端口时，数据均被锁存.
2)端口C：含一个8位数据输出锁存器和一个8位的数据输入缓冲器.作为**输出时能对数据进行锁存**，**输入时不能锁存.**端口C可以分成两个4位端口，分别可以定义为输入端口或输出端口，还可定义为控制、状态端口，以配合端口A和端口B工作.
(2)A组和B组
1)**端口A和端口C的高4位(PC7~PC4)构成A组**，由A组控制部件来对它进行控制。
2)**端口B和端口C的低4位(PC3~PC0)构成B组**，由B组控制部件对它进行控制.
**A组和B组各有一个控制单元，接收来自数据总线送来的控制字，并根据控制字确定各端口的工作状态和工作方式**

(3)数据缓冲器

数据缓冲器是一个双向的三态8位缓冲器，它与cpu系统数据总线相连。

**输入数据，输出数据，控制命令字**都是通过数据总线缓冲器进行传送的。

(4)读/写控制逻辑

读写控制逻辑接收来自CPU地址总线（$A_0 A_1$就是地址总线）的信号和控制信号，并发出命令到A组和B组，

1. 把CPU发出的控制命令字或输出的数据通过数据总线缓冲器送到相应的端口，
2. 把外设的状态或输入的数据从相应的端口通过数据总线缓冲器送到CPU。

### 控制字

可编程并行接口芯片，**可编程就是用指令的形式先对芯片进行初始化，**设置芯片的端口是处于输入状态还是输出状态以及每个端口的工作方式。

1. 8255A通过设置控制字来决定他的工作方式
2. 控制字分为两类：
   1. 工作方式控制字，可使8255A的三个数据端口工作在不同的方式
   2. C端口按位置位/复位控制字，它可使c端口中任何一位进行置位或复位


### 工作方式选择控制字



![image-20230920154306127](./接口技术和微机技术.assets/image-20230920154306127.png)

### 工作方式

1. 方式0 基本输入输出方式

   **功能：**方式0 是8255A的最简单工作模式之一，它将8255A的三个8位I/O端口（Port A、Port B 和 Port C）配置为一个单独的8位输出端口。这意味着三个端口同时用于输出，并且可以通过控制字配置输出的数据。

   基本输入输出方式适用于无条件传送和查询方式的接口电路;
   不需要应答联络信号;
   端口A、B和C的高4位及低4位都可以作为输入、输出端口;

2. 方式1 选通输入输出方式
   适用于查询和中断方式的接口电路;
   A和B口可用方式1，但要利用C口提供3个固定的信号，联络外设和CPU。

   **功能：**Mode 1将8255A的三个8位I/O端口分成两个组，Port A 和 Port B 组成一个双向数据总线，而 Port C 独立作为一个输入端口。这允许数据在 Port A 和 Port B 之间双向传输，而 Port C 用于输入

   当A口和B口都为方式1，则C口的6位被占用;C口的其他2位可作为方式0使用。
   A口或B口中，一个为方式1，另一个为方式0，则C口中有3位被占
   用;而其它5位可工作于方式0，设为输入或输出。

3. 方式2 双向选通输入输出方式

   方式2:双向选通传送方式
   适用于双向传送数据的外设
   适用于查询和中断方式的接口电路

## 中断系统和中断控制器8259A

### 8086CPU的中断系统
#### 中断系统的作用
- 多外设
- 实时处理
- 故障处理
#### 中断源
- 外部设备
- 定时中断
- 故障请求中断
- 程序性中断
外部中断：由连至CPU引脚上的信号引发
内部中断：由程序中断源引发
#### 中断屏蔽
为了增加中断控制的灵活性，CPU和I/O接口中分别设置触发器。
- CPU内部中断允许触发器（PSW.IF，控制可屏蔽中断）
	- 为0：关中断，指令CLI
	   为“1：开中断，指令STI
	- 可屏蔽中断（INT）受中断允许触发器控制：
	- 非屏蔽中断（NMI）**不受中断允许触发器控制**：
- 在接口电路中，设置中断请求触发器和中断屏蔽触发器
	- 有中断请求时中断请求触发器置1；
	- 若中断屏蔽触发器为“0，该请求送往CPU，CPU响应后触发器清“0
	- 若中断屏蔽触发器为“1，该请求不送往CPU，称该中断请求被屏蔽
#### 终端优先级
几个中断源同时请求中断，而CPU一次只能为一个中断服务；
  事先为每个中断源确定一个中断优先级
  CPU一般首先响应优先权高的中断请求
#### 中断嵌套
  允许高优先权中断源打断优先权低的中断服务，称为中断嵌套
 若新的中断源为同级或低级，（一般）不能打断正在处理的中断服务。
#### 中断优先级和中断嵌套的实现
   先**判别**优先级，进而解决多个中断**排队**和实现中断**嵌套**
   **CPU内部中断逻辑**可以确定**内部中断**、**外部非屏蔽中断（NMI）** 和**可屏蔽中断（INTR）**  间的等级关系；
  **外部可屏蔽中断源的优先级需要通过软件（CPU）或*硬件（接口）* 方案解决**
##### 软件确定中断优先权
  - CPU在中断服务程序中查询确定是哪个中断源提出中断请求查询的次序决定了中断优先次序，最先被查询的优先级最高
  - **优点**：不需要复杂的硬件电路，简单易实现；
  - **缺点**：中断源较多时查询时间长，中断响应速度慢。
![](attachements/Pasted%20image%2020230927195109.png)
##### 硬件确定中断优先权
**链式优先权排队电路**：中断源串行连接形成链，用逻辑电路代替查询程序。某中断源得到CPU中断服务后，封锁后面中断源的中断请求，前面的中断源可以提出申请。
**专用硬件一中断控制器**
如Intel8259A，具有8个优先权控制，经级联可扩展至64级。编程设置工作方式，方便灵活
### 8259A 中断工作方式
#### 中断控制器8259A功能
现代计算机采用功能很强的中断系统，可同时处理多个中断源，配置中断控制器管理外部中断，功能如下：
1. 接收外部的**中断请求**；
2. 确认当前**优先级**最高的请求，并送至CPU的INTR引脚
3. 当CPU响应中断时，提供**中断类型码**：
4. 中断处理过程中**屏蔽**低优先权的中断请求，而允许高优先权的中断请求送出，实现中断嵌套；
5. Intel8259A是典型的中断控制器芯片，广泛应用于微机系统中。
#### 8259A的性能概述
- 每片8259A能管理8级中断，可采用9片级联构成主从式64级中断管理系统；
- 每级中断都可以被**屏蔽或允许**；
- 中断响应期间提供**中断类型码：**
- 允许多级中断**嵌套；**
- 可设置**多种**优先权管理方式及屏蔽功能；
- 可编程选择不同的**工作方式**
- 提供**中断查询**（中断查询（Interrupt Polling）是一种中断处理方法，用于检查外部设备是否发生了中断请求，而不是依赖硬件中断信号来通知计算机系统。），使得CPU在关中断的情况下仍可通过查询为特定中断服务。
#### 8259A 的结构和引脚
示意图：
![](attachements/Pasted%20image%2020230927204515.png)
##### 8259A的引脚功能
- 电源VCC和接地GND
- **中断请求输入线**IR7~IRO：接受来自外设或8259A从片的中断请求信号，可设置为上升沿或高电平触发；
- 双向三态数据线D7~DO 与系统数据总线相连；
- 中断请求线INT：输出信号，与CPU的INTR相连，向CPU送中断请求信号；
- 中断响应线INTA：接收CPU发来的中断响应信号，8259A接到此信号后，送中断类型码：
- 片选信号CS： 高位地址译码产生；
- 地址线AO： 选择8259A内部不同寄存器；
- 读信号RD：读取IRR、ISR和IMR
- 写信号WR：写入控制字；
- 级联线CAS2~CASO：主从系统中所有CAS2~CAS0引脚对应连接在一起，与SP/EN信号配合级联。8259A主片**用于输出**，**从片用于输入**。**在CPU响应中断时，主片用CAS2~CAS0选中对应的从片，三个引脚信号的不同组合000~111，对应于8个从片**
- 从片编程/缓冲使能SP/EN：双向。在**非缓冲**方式下，用作输入线SP，SP=1表示该8259A为主片，否则为从片；缓冲方式下用作输出线EN，控制外接数据缓冲器的接收和发送。
	-  在非缓冲方式下，"SP/EN" 用作输入线 SP（Slave Present），表示该 8259A 控制器是主片还是从片。
		- 当 SP=1 时，表示该 8259A 控制器是主片（Master），用于处理中断请求。
		- 当 SP=0 时，表示该 8259A 控制器是从片（Slave），通常用于级联连接多个 8259A 控制器以处理更多的中断请求。
	- 在非缓冲方式下，"SP/EN" 不用作输出线。
		- 在缓冲方式下，"SP/EN" 用作输出线 EN（Enable），用于控制外接数据缓冲器的接收和发送。
		- 当 "SP/EN" 为高电平时（EN=1），外接数据缓冲器被启用，允许 8259A 控制器发送中断请求和接收中断控制命令。
		- 当 "SP/EN" 为低电平时（EN=0），外接数据缓冲器被禁用，停止发送和接收操作。
##### 内部结构
 **中断请求寄存器IRR**：8位，用于锁存中断请求信号。当相应的引脚有中断请求时，寄存器的相应位置1；
**优先权判别电路PR**：识别同时申请的中断的优先级，允许嵌套时须考虑正在服务中断的优先级别，然后送出最高优先级中断源，并在CPU响应周期中将中断服务寄存器ISR的相应位置位。
**中断服务寄存器ISR**：8位，记录已响应的中断。该位由普通或特殊EOI命令复位。中断嵌套时，会有多个位同时被置位，对应已响应而又未处理完毕的多个中断
**中断屏蔽寄存器IMR**:8位，存放被屏的中断，由编程设定。当IMR中某位被屏蔽即使IRR对应位被置位，其中断申请也不能送往CPU；
**数据总线缓冲器**：8位双向三态缓冲器，是8259A与CPU间的数据传输通道。写入控制字，读出状态信息。中断响应周期内，向CPU送中断类型码
**级联缓冲比较器**：实现8259A的级联，构成主从式扩展中断管理系统；
**读写控制逻辑**：根据编程设定工作方式产生片内控制信号：据IRR、IMR的内容和PR的判断结果向CPU发出中断请求；并接受来自CPU的中断响应信号。
#### 8259A 工作过程
1. 1个或同时多个外部中断请求送至8259A 引脚
2. IRR接收中断请求并锁存，相应位置置位1；
3. 根据IMR的屏蔽情况决定是否允许中断请求进入PR；
4. PR判别当前优先级最高的中断请求（允许嵌套时还要参考ISR的状态），根据判优结果决定发送INTR信号或等待
5. 若IF=1（8086CPU 标志寄存器FR中的一位，IF=1表明允许中断）,发送INT信号，8259A 使ISR相应位置位，同时将IRR相应位清零避免重发请求
6. 然后CPU发送第二个INT后8259A 送出类型码
7. 若为AEOI方式（自动结束），直接清除ISR相应位置，否则需要在中断服务结束时，由CPU送出普通或特殊中断结束命令EOI，清除ISR响应的位，标志一个中断结束
#### 中断触发方式
1. ***电平触发***
	中断请求线上出现**高电平**为有效请求信号。
	对其时间有限制：过短，不能触发；过长，重复触发
	要求触发高电平持续至cpu响应总线周期中第一个INTA脉冲
2. ***边缘触发***
	中断请求线上出现**上升沿**为中断请求信号，触发后一直保持高电平也不会重复触发。常用负脉冲的后沿实现，**同时要防止第1个INTA信号有效前出现新的中断请求脉冲。**
#### 屏蔽中断源的方式
清除IF指令（CLI）可使CPU屏蔽所以可屏蔽中断，但无法屏蔽**选择性屏蔽**。
8259A可选择性屏蔽。
1. 普通屏蔽方式
	将中断屏蔽寄存器IMR的某些位置1，选择性屏蔽对应编程
1. 特殊屏蔽方式
#### 中断优先权的四种方式
#### 中断结束的四种方式
1. 自动结束方式（有风险但是简单）：
	cpu一旦中断响应8259A 将自动ISR相应位置清零。由于不能再为PR提供判优依据，会造成重复嵌套。
	常用在不允许中断嵌套或保证不出现中断嵌套的情况下
#### 8259A 的编程
8259A 工作方式可以编程设定
#####  8259A 的端口
- 8259A占用**两个I/O端口地址**，通过A0引脚区分:
- 通常称低的地址为**偶地址**，而高的地址为**奇地址;**
- 8259A内部并不是只有两个寄存器，为**区分对不同寄存器(命令)的输入/输出操作**，需要采用在控制信息中加**特征位**或者规定有关**操作顺序**等方法。
##### 初始化命令字
8259A 开始工作时，必须首先写入ICW，使其处于预定的初始状态，并明确其所处的硬件环境；
ICW设定后整个工作过程中**保持不变**（除非断电重启）

***ICW1:***
![](Pasted%20image%2020230927150344.png)

***ICW2***:
![](Pasted%20image%2020230927150713.png)

高5位自己设置，随便设置，不要和系统的中断类型冲突
后三位是8级中断类型码，对应8个中断请求线

***ICW3***：
![](Pasted%20image%2020230927150953.png)

***ICW4***：
![](Pasted%20image%2020230927151054.png)

######  初始化规则
- 开始工作前，**每一片**8259A都要通过写入ICW**初始化;**
- ICW1~4的写入顺序固定，其中ICW1,和ICW2必须设置，而ICW3和ICW4可选;
- **ICW1**写入偶地址，并指明是否要**ICW3和ICW4;**
	- 写入ICW1启动8259A的初始化，内部电路自动完成:边沿触发、电路复位、**IMR（Interrupt Mask Register用于屏蔽或允许特定中断请求线）清0**、**IR7（Interrupt Request 7是指8259A芯片中的IRQ7，对应着第7个中断请求线）被置为最低优先级**、普通全嵌套方式、 固定优先权排序、清除特殊屏蔽方式、读IRR状态;
- ICW2~4写入奇地址，按写入顺序加以区分;
- 级联方式下，主、从片都需设置ICW3。
***示意图：***
![](Pasted%20image%2020230927151414.png)
##### 操作命令字

***OCW1（写中断屏蔽IMR）***
![](Pasted%20image%2020230927152831.png)

***OCW2***
![](Pasted%20image%2020230927153046.png)
- 控制**优先权方式**和**中断结束方式**，写入偶地址;
- D4D3是特征位;
- R:优先权控制位，若R=1循环优先级，R=0固定优先级;
- SL:指定L₂~L。位是否有效，SL=1，L位有效;SL=0,L无效;
- EOI:中断结束命令位。当ICW4中AEOI=0，则中断服务程序最后不会发中断结束(EOI)，则需要将OCW2作为EOI命令，用以清除ISR的对应位;
- L₂~L。：（就是类似一种参数）位:在SL=1时有效，编码指示对应要操作的中断级别。

